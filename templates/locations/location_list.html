{% extends 'base.html' %}
{% load static %}

{% block title %}Наши филиалы | ЮАнна студия массажа{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
{% endblock %}

{% block content %}
<div class="container py-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Главная</a></li>
            <li class="breadcrumb-item active" aria-current="page">Наши филиалы</li>
        </ol>
    </nav>

    <h1 class="text-center brand-font mb-5">Наши филиалы</h1>
    
    <!-- Карта всех филиалов -->
    <div class="card border-0 shadow-sm mb-5">
        <div class="card-body">
            <div id="all-locations-map" style="height: 400px;"></div>
        </div>
    </div>
    
    <div class="row">
        {% for location in locations %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                {% if location.image %}
                <img src="{{ location.image.url }}" class="card-img-top" alt="{{ location.name }}" style="height: 200px; object-fit: cover;">
                {% else %}
                <div class="bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                    <i class="bi bi-building text-primary" style="font-size: 4rem;"></i>
                </div>
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title brand-font">{{ location.name }}</h5>
                    <p class="mb-2"><i class="bi bi-geo-alt-fill text-primary me-2"></i> {{ location.address }}</p>
                    <p class="mb-2"><i class="bi bi-telephone-fill text-primary me-2"></i> {{ location.phone }}</p>
                    <p class="mb-2"><i class="bi bi-clock-fill text-primary me-2"></i> {{ location.working_hours }}</p>
                </div>
                <div class="card-footer bg-white border-0">
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'location_detail' location.id %}" class="btn btn-outline-primary">Подробнее</a>
                        <a href="{% url 'appointment_create' %}?location_id={{ location.id }}" class="btn btn-primary">Записаться</a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">
                <p class="mb-0">К сожалению, информация о филиалах временно недоступна.</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Координаты всех филиалов
        var locations = [
            {% for location in locations %}
            {
                name: "{{ location.name }}",
                address: "{{ location.address }}",
                lat: {{ location.latitude|default:"53.2007" }},
                lng: {{ location.longitude|default:"45.0046" }},
                id: {{ location.id }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Инициализация карты
        var map = L.map('all-locations-map');
        
        // Добавление слоя OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Массив для хранения маркеров
        var markers = [];
        
        // Добавление маркеров для каждого филиала
        locations.forEach(function(loc) {
            var marker = L.marker([loc.lat, loc.lng])
                .addTo(map)
                .bindPopup("<b>" + loc.name + "</b><br>" + loc.address + "<br><a href='/locations/" + loc.id + "/' class='text-primary'>Подробнее</a>");
            
            markers.push(marker);
        });
        
        // Настраиваем масштаб и центр карты, чтобы видеть все маркеры
        if (markers.length > 0) {
            var group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        } else {
            // Если маркеров нет, показываем центр Пензы
            map.setView([53.2007, 45.0046], 12);
        }
    });
</script>
{% endblock %}